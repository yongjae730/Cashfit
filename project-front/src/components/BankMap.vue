<template>
  <div class="map-container">
    <div class="filter-section">
      <select v-model="sido" class="select-box" @change="onSidoChange">
        <option value="">시 / 도 선택</option>
        <option v-for="sido in sidoList">
          {{ sido }}
        </option>
      </select>

      <select v-model="sigugun" class="select-box">
        <option value="">구 / 군 선택</option>
        <option v-for="sigugun in sigugunList">
          {{ sigugun }}
        </option>
      </select>
      <button @click="searchBranches" class="search-button">검색</button>
    </div>
    <div class="content-container">
      <div ref="mapContainer" class="map-view"></div>
      <div class="place-list" v-if="places.length > 0">
        <h2>검색 결과 ({{ places.length }})</h2>
        <div v-for="(place, index) in places" :key="place.id" class="place-item" @click="focusPlace(index)" @mouseover="highlightMarker(index)" @mouseleave="unhighlightMarker(index)">
          <h3>{{ place.place_name }}</h3>
          <p class="address">{{ place.address_name }}</p>
          <p class="phone">{{ place.phone || "전화번호 없음" }}</p>
          <div class="distance" v-if="place.distance">
            {{ formatDistance(place.distance) }}
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { useAddressStore } from "@/stores/address";
import { computed, onMounted, ref } from "vue";

const KAKAO_API_KEY = import.meta.env.VITE_KAKAO_API_KEY;
const addressStore = useAddressStore();

const sido = ref("");
const sigugun = ref("");
const places = ref([]); // 검색 결과 저장
const activeMarkerIndex = ref(null);

const sidoList = computed(() => addressStore.address_infos.map((info) => info.sido));
const sigugunList = computed(() => {
  const selectedSido = addressStore.address_infos.find((info) => info.sido === sido.value);
  return selectedSido ? selectedSido.sigungus : [];
});

const onSidoChange = () => {
  sigugun.value = null;
};

// 거리 포맷팅 함수
const formatDistance = (distance) => {
  if (distance < 1000) {
    return `${distance}m`;
  }
  return `${(distance / 1000).toFixed(1)}km`;
};

const props = defineProps({
  bank: {
    type: String,
    required: true,
  },
});

// Kakao 지도 관련
const mapContainer = ref(null);
const mapInstance = ref(null);
const markers = ref([]);

onMounted(() => {
  if (!KAKAO_API_KEY) {
    alert("Kakao API 키가 설정되지 않았습니다. .env 파일을 확인하세요.");
    return;
  }
  loadKaKaoMap(mapContainer.value);
});

const loadKaKaoMap = (container) => {
  if (window.kakao && window.kakao.maps) {
    initMap(container);
    return;
  }

  const script = document.createElement("script");
  script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${KAKAO_API_KEY}&libraries=services&autoload=false`;
  document.head.appendChild(script);

  script.onload = () => {
    window.kakao.maps.load(() => initMap(container));
  };

  script.onerror = () => {
    alert("Kakao Maps API를 로드할 수 없습니다.");
  };
};

const initMap = (container) => {
  const options = {
    center: new window.kakao.maps.LatLng(33.450701, 126.570667),
    level: 1,
  };

  mapInstance.value = new window.kakao.maps.Map(container, options);

  window.kakao.maps.event.addListener(mapInstance.value, "click", (mouseEvent) => {
    console.log(mouseEvent.latLng);
  });
};

// 마커 포커스 함수
const focusPlace = (index) => {
  const place = places.value[index];
  const moveLatLng = new window.kakao.maps.LatLng(place.y, place.x);
  mapInstance.value.setCenter(moveLatLng);

  // 해당 마커의 인포윈도우 열기
  if (markers.value[index]) {
    const marker = markers.value[index];
    marker.infoWindow.open(mapInstance.value, marker);
  }
};

// 마커 하이라이트 함수들
const highlightMarker = (index) => {
  activeMarkerIndex.value = index;
  if (markers.value[index]) {
    const marker = markers.value[index];
    marker.infoWindow.open(mapInstance.value, marker);
  }
};

const unhighlightMarker = (index) => {
  activeMarkerIndex.value = null;
  if (markers.value[index]) {
    const marker = markers.value[index];
    marker.infoWindow.close();
  }
};

const addMarker = (position, place) => {
  const marker = new window.kakao.maps.Marker({ position });
  marker.setMap(mapInstance.value);

  const infoWindow = new window.kakao.maps.InfoWindow({
    content: `<div style="padding:5px">${place.place_name}</div>`,
  });

  // 마커 객체에 인포윈도우 저장
  marker.infoWindow = infoWindow;

  window.kakao.maps.event.addListener(marker, "click", () => {
    infoWindow.open(mapInstance.value, marker);
  });

  markers.value.push(marker);
};

const adjustMapBounds = () => {
  if (markers.value.length === 0) return;
  const bounds = new window.kakao.maps.LatLngBounds();

  markers.value.forEach((marker) => {
    bounds.extend(marker.getPosition());
  });

  mapInstance.value.setBounds(bounds);
};

const searchBranches = () => {
  const ps = new window.kakao.maps.services.Places();
  const query = `${sido.value} ${sigugun.value} ${props.bank}`;

  ps.keywordSearch(query, (data, status, pagination) => {
    if (status === window.kakao.maps.services.Status.OK) {
      // 기존 마커 제거
      markers.value.forEach((marker) => marker.setMap(null));
      markers.value = [];

      // 검색 결과 저장
      places.value = data;

      data.forEach((place) => {
        const position = new window.kakao.maps.LatLng(place.y, place.x);
        addMarker(position, place);
      });

      // 첫 번째 검색 결과로 지도 중심 이동
      // const firstPlace = data[0];
      // mapInstance.value.setCenter(new window.kakao.maps.LatLng(firstPlace.y, firstPlace.x));
      adjustMapBounds();
    } else if (status === window.kakao.maps.services.Status.ZERO_RESULT) {
      swal({
        title: "ㅠㅠ",
        text: "검색 결과가 없어요..",
        icon: "warning",
        button: "확인",
      });
      places.value = [];
    } else {
      swal({
        title: "헉!",
        text: "검색 중 오류가 발생했어요.",
        icon: "warning",
        button: "확인",
      });
      places.value = [];
    }
  });
};
</script>

<style scoped>
.map-container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.filter-section {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.select-box {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  min-width: 150px;
  background-color: white;
}

.search-button {
  padding: 8px 20px;
  background-color: #1a73e8;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.2s;
}

.search-button:hover {
  background-color: #1557b0;
}

.content-container {
  display: flex;
  gap: 20px;
  margin-top: 20px;
}

.map-view {
  flex: 1;
  height: 600px;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #ddd;
}

.place-list {
  width: 300px;
  background: white;
  border-radius: 8px;
  border: 1px solid #ddd;
  padding: 16px;
  overflow-y: auto;
  max-height: 600px;
}

.place-list h2 {
  margin: 0 0 16px 0;
  font-size: 18px;
  color: #333;
}

.place-item {
  padding: 12px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  transition: background-color 0.2s;
}

.place-item:last-child {
  border-bottom: none;
}

.place-item:hover {
  background-color: #f5f5f5;
}

.place-item h3 {
  margin: 0 0 8px 0;
  font-size: 16px;
  color: #1a73e8;
}

.place-item .address {
  margin: 4px 0;
  font-size: 14px;
  color: #666;
}

.place-item .phone {
  margin: 4px 0;
  font-size: 14px;
  color: #888;
}

.place-item .distance {
  margin-top: 4px;
  font-size: 12px;
  color: #1a73e8;
}
</style>
